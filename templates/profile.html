{% extends "base.html" %}
{% load static %}
{% load form_filters %}

{% block content %}
<div class="min-h-screen py-12 bg-gray-100">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 space-y-10">

    <!-- ‚úÖ Profile Header -->
    <div class="bg-white p-6 rounded-lg shadow-sm flex flex-col md:flex-row gap-6 items-start md:items-center">
      <div class="relative">
        <div class="w-24 h-24 bg-indigo-600 rounded-full flex items-center justify-center text-white text-3xl font-bold">
          {{ user.first_name|default:user.username|slice:":1" }}{{ user.last_name|default_if_none:""|slice:":1" }}
        </div>
        <div class="absolute -bottom-2 -right-2 w-7 h-7 bg-green-500 rounded-full flex items-center justify-center">
          ‚úÖ
        </div>
      </div>

      <div class="flex-1 text-left">
        <div class="flex items-center gap-2 mb-1">
          <h1 class="text-2xl font-bold">{{ user.first_name }} {{ user.last_name }}</h1>
          <span class="text-xs px-2 py-1 bg-green-600 text-white rounded">Verified</span>
        </div>
        <p class="text-sm text-gray-500">{{ user.profile.bio|default:"No bio yet." }}</p>
        <p class="text-sm text-gray-500 pt-1">
          üìß {{ user.email }} | 
          üìç {{ user.profile.location|default:"Not set" }} | 
          üóì Member since {{ user.date_joined|date:"F Y" }}
        </p>
      </div>

      <!-- ‚úÖ Toggle Edit Button -->
      {% if not is_editing %}
      <div class="self-start md:self-auto w-full md:w-auto">
        <a href="{% url 'profile' %}?edit=1" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 text-sm inline-block">
          ‚úèÔ∏è Edit Profile
        </a>
      </div>
      {% endif %}
    </div>

    <!-- ‚úÖ Editable Form Section -->
    {% if is_editing %}
    <div class="bg-white p-6 rounded-lg shadow grid grid-cols-1 md:grid-cols-2 gap-6">
      <form method="post" class="w-full col-span-full space-y-6">
        {% csrf_token %}

        {% if user_form.non_field_errors %}
          <div class="text-red-600 text-sm">
            {{ user_form.non_field_errors }}
          </div>
        {% endif %}
        {% if profile_form.non_field_errors %}
          <div class="text-red-600 text-sm">
            {{ profile_form.non_field_errors }}
          </div>
        {% endif %}

        <div class="grid gap-4 sm:grid-cols-2">
          <div>
            <label class="text-sm text-gray-700 block mb-1">First Name</label>
            {{ user_form.first_name|add_class:"w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm focus:ring-2 focus:ring-indigo-500 focus:outline-none" }}
            {{ user_form.first_name.errors }}
          </div>
          <div>
            <label class="text-sm text-gray-700 block mb-1">Last Name</label>
            {{ user_form.last_name|add_class:"w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm focus:ring-2 focus:ring-indigo-500 focus:outline-none" }}
            {{ user_form.last_name.errors }}
          </div>
        </div>
          
        <div>
          <label class="text-sm text-gray-700 block mb-1">Email Address</label>
          {{ user_form.email|add_class:"w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm focus:ring-2 focus:ring-indigo-500 focus:outline-none" }}
          {{ user_form.email.errors }}
        </div>

        <div>
          <label class="text-sm text-gray-700 block mb-1">Phone</label>
          {{ profile_form.phone|add_class:"w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm focus:ring-2 focus:ring-indigo-500 focus:outline-none" }}
          {{ profile_form.phone.errors }}
        </div>

        <div>
          <label class="text-sm text-gray-700 block mb-1">Location</label>
          {{ profile_form.location|add_class:"w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm focus:ring-2 focus:ring-indigo-500 focus:outline-none" }}
          {{ profile_form.location.errors }}
        </div>

        <div>
          <label class="text-sm text-gray-700 block mb-1">Bio</label>
          {{ profile_form.bio|add_class:"w-full px-4 py-2 min-h-[100px] border border-gray-300 rounded-md shadow-sm text-sm focus:ring-2 focus:ring-indigo-500 focus:outline-none" }}
          {{ profile_form.bio.errors }}
        </div>

        <!-- Buttons -->
        <div class="flex gap-4 mt-4">
          <button type="submit" class="bg-indigo-600 text-white px-6 py-2 rounded hover:bg-indigo-700">
           Save Changes
          </button>
          <a href="{% url 'profile' %}" class="border px-6 py-2 rounded hover:bg-gray-100">
           Cancel
          </a>
        </div>
      </form>
    </div>
    {% endif %}

    <!-- ‚úÖ Booking History -->
    <div class="bg-white p-6 rounded-lg shadow">
      <h2 class="text-xl font-semibold mb-4">Booking History</h2>

      {% if bookings %}
      <div class="space-y-4">
        {% for booking in bookings %}
        <div class="flex items-center gap-4 p-3 border rounded hover:shadow transition">
          <img src="{{ booking.event.image_url }}" alt="{{ booking.event.title }}" class="w-16 h-16 rounded-md object-cover" />
          <div class="flex-1">
            <div class="text-lg font-semibold text-gray-800">{{ booking.event.title }}</div>
            <div class="text-sm text-gray-500">{{ booking.event.date|date:"F j, Y | h:i A" }}</div>
            <div class="text-sm text-gray-400">Booked on {{ booking.booked_at|date:"F j, Y" }}</div>
          </div>
          <a href="{% url 'event_detail' booking.event.id %}" class="text-sm text-indigo-600 hover:underline">View</a>
        </div>
        {% endfor %}
      </div>
      {% else %}
        <p class="text-gray-600">You haven‚Äôt booked any events yet. <a href="{% url 'events_list' %}" class="text-indigo-600 underline">Browse Events</a></p>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}